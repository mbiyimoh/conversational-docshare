# Document Editing & Versioning

**Status:** Draft
**Authors:** Claude Code
**Date:** 2025-12-07
**Related:** `docs/ideation/collaborative-capsule-enhancements.md`

---

## Overview

Enable project owners to edit text-based documents (DOCX, Markdown, plain text) directly within the application using a rich text editor. Maintain full version history with diff viewing and rollback capabilities. PDF documents remain read-only due to their binary nature.

This feature is foundational for the collaborative capsule enhancement initiative, enabling document updates based on conversation insights and collaborator feedback.

---

## Background/Problem Statement

Currently, documents uploaded to the platform are immutable. If a project owner wants to update document content based on:
- Feedback from conversations with viewers
- Recommendations generated by the AI after conversation analysis
- Collaborator comments

They must re-upload the entire document, losing conversation context and analytics continuity.

**Core Problem:** Document content cannot evolve with the insights gathered from audience interactions.

**Root Cause:** The system was designed for static document sharing, not iterative document refinement.

---

## Goals

- Allow project owners to edit text document content inline using TipTap editor
- Create automatic version snapshots on each save
- Provide version history with timestamps and change notes
- Enable diff viewing between any two versions
- Support rollback to any previous version
- Regenerate embeddings after edits to maintain RAG accuracy
- Preserve original version (v1) permanently

---

## Non-Goals

- Real-time collaborative editing (Google Docs style)
- PDF editing or annotation
- Conflict resolution for concurrent edits
- Direct editing of the original uploaded file
- Mobile-optimized editing experience
- Commenting within the editor (separate feature in Spec 2)

---

## Technical Dependencies

### New Dependencies (Frontend)

| Package | Version | Purpose |
|---------|---------|---------|
| `@tiptap/react` | `^2.1.0` | React integration for TipTap |
| `@tiptap/starter-kit` | `^2.1.0` | Essential extensions bundle |
| `@tiptap/extension-placeholder` | `^2.1.0` | Placeholder text support |
| `@tiptap/extension-highlight` | `^2.1.0` | Text highlighting for diffs |
| `diff` | `^5.1.0` | Text diffing for version comparison |

### Existing Dependencies Used

| Package | Purpose |
|---------|---------|
| `react-markdown` | Render markdown content in viewer mode |
| `@radix-ui/react-dialog` | Modal for version history |
| `@radix-ui/react-dropdown-menu` | Version selector dropdown |
| `lucide-react` | Icons for edit, save, history actions |
| `date-fns` | Format version timestamps |

### Backend Dependencies

No new backend dependencies required. Uses existing:
- Prisma for database operations
- Express for API routes
- OpenAI for embedding regeneration

---

## Detailed Design

### Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Frontend                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐ │
│  │ DocumentUpload  │  │ DocumentEditor  │  │ DocumentVersion     │ │
│  │ (add Edit btn)  │→ │ (TipTap editor) │  │ History             │ │
│  └─────────────────┘  └────────┬────────┘  └──────────┬──────────┘ │
│                                │                       │            │
│                                ▼                       ▼            │
│                     ┌──────────────────────────────────────────┐   │
│                     │              api.ts                       │   │
│                     │  updateDocumentContent()                 │   │
│                     │  getDocumentVersions()                   │   │
│                     │  rollbackToVersion()                     │   │
│                     └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Backend                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 document.controller.ts                       │   │
│  │  PUT  /api/documents/:id/content                            │   │
│  │  GET  /api/documents/:id/versions                           │   │
│  │  POST /api/documents/:id/rollback                           │   │
│  │  GET  /api/documents/:id/versions/:version                  │   │
│  └────────────────────────────┬────────────────────────────────┘   │
│                               │                                     │
│                               ▼                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐ │
│  │ DocumentVersion │  │ DocumentChunk   │  │ embeddingService    │ │
│  │ (create snapshot│  │ (update content)│  │ (regenerate async)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### Data Model Changes

#### New Model: DocumentVersion

```prisma
// Add to schema.prisma after DocumentChunk model

model DocumentVersion {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  version    Int      // Sequential version number (1, 2, 3...)
  content    Json     // Full document content snapshot as structured JSON

  // Edit metadata
  editedById  String?  // User ID who made the edit (null for v1 original)
  editedBy    User?    @relation(fields: [editedById], references: [id])
  changeNote  String?  @db.Text  // Optional description of changes

  // Source tracking (for recommendations feature integration)
  source      String?  // "manual" | "recommendation" | "import"
  sourceId    String?  // Reference to recommendation ID if applicable

  createdAt   DateTime @default(now())

  @@unique([documentId, version])
  @@index([documentId])
  @@map("document_versions")
}
```

#### Modify Document Model

```prisma
model Document {
  // ... existing fields ...

  // Add new fields
  currentVersion  Int  @default(1)
  isEditable      Boolean @default(false)  // Set based on mimeType during processing

  // Add relation
  versions  DocumentVersion[]

  // ... existing relations ...
}
```

#### Content JSON Structure

```typescript
interface DocumentContentJSON {
  // TipTap document structure
  type: 'doc'
  content: TipTapNode[]
}

interface TipTapNode {
  type: 'paragraph' | 'heading' | 'bulletList' | 'orderedList' | 'listItem' | 'codeBlock' | 'blockquote'
  attrs?: Record<string, unknown>
  content?: TipTapNode[]
  text?: string
  marks?: TipTapMark[]
}

interface TipTapMark {
  type: 'bold' | 'italic' | 'code' | 'link'
  attrs?: Record<string, unknown>
}
```

### API Endpoints

#### 1. Update Document Content

```typescript
// PUT /api/documents/:id/content
// Authorization: Project owner only

interface UpdateContentRequest {
  content: DocumentContentJSON  // TipTap JSON structure
  changeNote?: string           // Optional description
}

interface UpdateContentResponse {
  document: {
    id: string
    currentVersion: number
    updatedAt: string
  }
  version: {
    id: string
    version: number
    createdAt: string
  }
}

// Implementation flow:
// 1. Verify user is project owner
// 2. Create DocumentVersion snapshot
// 3. Convert TipTap JSON to plain text
// 4. Update DocumentChunk records
// 5. Queue embedding regeneration (async)
// 6. Update document outline if headers changed
// 7. Return new version info
```

#### 2. Get Version History

```typescript
// GET /api/documents/:id/versions
// Authorization: Project owner only

interface VersionHistoryResponse {
  versions: Array<{
    id: string
    version: number
    editedById: string | null
    editedByName: string | null
    changeNote: string | null
    source: string | null
    createdAt: string
  }>
  currentVersion: number
}
```

#### 3. Get Specific Version Content

```typescript
// GET /api/documents/:id/versions/:version
// Authorization: Project owner only

interface VersionContentResponse {
  version: {
    id: string
    version: number
    content: DocumentContentJSON
    editedById: string | null
    editedByName: string | null
    changeNote: string | null
    createdAt: string
  }
}
```

#### 4. Rollback to Version

```typescript
// POST /api/documents/:id/rollback
// Authorization: Project owner only

interface RollbackRequest {
  targetVersion: number
  changeNote?: string  // Defaults to "Rollback to version X"
}

interface RollbackResponse {
  document: {
    id: string
    currentVersion: number  // This is a NEW version, not the target
  }
  version: {
    id: string
    version: number
    createdAt: string
  }
}

// Note: Rollback creates a NEW version with the old content
// This preserves full history and audit trail
```

### Frontend Components

#### 1. DocumentEditor Component

```typescript
// frontend/src/components/DocumentEditor.tsx

interface DocumentEditorProps {
  documentId: string
  initialContent: DocumentContentJSON
  onSave: (content: DocumentContentJSON, changeNote?: string) => Promise<void>
  onClose: () => void
}

// Features:
// - TipTap editor with StarterKit extensions
// - Toolbar: Bold, Italic, Headings (1-3), Lists, Code, Blockquote
// - Auto-save indicator (unsaved changes warning)
// - Save button with optional change note input
// - Keyboard shortcut: Cmd/Ctrl+S to save
// - Close confirmation if unsaved changes exist
```

#### 2. DocumentVersionHistory Component

```typescript
// frontend/src/components/DocumentVersionHistory.tsx

interface DocumentVersionHistoryProps {
  documentId: string
  currentVersion: number
  onVersionSelect: (version: number) => void
  onRollback: (version: number) => void
}

// Features:
// - Timeline view of all versions
// - Each version shows: number, date, editor name, change note
// - Badge for v1 "Original"
// - Badge for current version
// - "View" button to see content
// - "Rollback" button (with confirmation)
// - Diff view toggle to compare any two versions
```

#### 3. DocumentDiffViewer Component

```typescript
// frontend/src/components/DocumentDiffViewer.tsx

interface DocumentDiffViewerProps {
  oldContent: string      // Plain text from version A
  newContent: string      // Plain text from version B
  oldVersion: number
  newVersion: number
}

// Features:
// - Side-by-side or inline diff view
// - Additions highlighted in green
// - Deletions highlighted in red
// - Line numbers
// - Collapsible unchanged sections
```

### File Structure

```
frontend/src/
├── components/
│   ├── DocumentEditor.tsx          # NEW - TipTap editor wrapper
│   ├── DocumentEditorToolbar.tsx   # NEW - Formatting toolbar
│   ├── DocumentVersionHistory.tsx  # NEW - Version list and controls
│   ├── DocumentDiffViewer.tsx      # NEW - Diff comparison view
│   ├── DocumentUpload.tsx          # MODIFY - Add Edit button
│   └── DocumentViewer.tsx          # MODIFY - Add version indicator
├── lib/
│   ├── api.ts                      # MODIFY - Add version endpoints
│   └── tiptap-utils.ts             # NEW - JSON ↔ plaintext conversion
└── hooks/
    └── useDocumentVersions.ts      # NEW - Version management hook

backend/src/
├── controllers/
│   └── document.controller.ts      # MODIFY - Add version endpoints
├── services/
│   ├── documentVersioning.ts       # NEW - Version management logic
│   └── embeddingService.ts         # MODIFY - Add regeneration queue
└── routes/
    └── document.routes.ts          # MODIFY - Add version routes
```

### Data Flow: Edit and Save

```
User clicks "Edit" on document
        │
        ▼
┌───────────────────────────────────┐
│ Load current version content       │
│ GET /api/documents/:id/versions/   │
│     :currentVersion                │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│ TipTap editor renders content     │
│ User makes edits                  │
└───────────────┬───────────────────┘
                │
                ▼
User clicks "Save"
        │
        ▼
┌───────────────────────────────────┐
│ PUT /api/documents/:id/content    │
│ Body: { content, changeNote }     │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│ Backend: Create DocumentVersion   │
│ (snapshot before changes)         │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│ Convert TipTap JSON to plain text │
│ Update DocumentChunk records      │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│ Queue async embedding regeneration│
│ processingQueue.add('embeddings', │
│   { documentId, chunks })         │
└───────────────┬───────────────────┘
                │
                ▼
┌───────────────────────────────────┐
│ Return success response           │
│ { document, version }             │
└───────────────────────────────────┘
```

### Integration: Document Processing Pipeline

When a document is initially uploaded:

```typescript
// In documentProcessor.ts - add after text extraction

async function processDocument(documentId: string): Promise<void> {
  // ... existing extraction logic ...

  // Determine if document is editable
  const isEditable = ['text/markdown', 'text/plain',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
  ].includes(mimeType)

  // Create initial version (v1)
  if (isEditable) {
    const contentAsJSON = convertPlainTextToTipTapJSON(fullText)

    await prisma.documentVersion.create({
      data: {
        documentId,
        version: 1,
        content: contentAsJSON,
        editedById: null,  // Original upload, no editor
        changeNote: 'Original document',
        source: 'import'
      }
    })
  }

  // Update document
  await prisma.document.update({
    where: { id: documentId },
    data: {
      isEditable,
      currentVersion: 1
    }
  })
}
```

### Embedding Regeneration Strategy

```typescript
// In embeddingService.ts

interface RegenerateEmbeddingsJob {
  documentId: string
  chunkIds: string[]
  priority: 'high' | 'normal'
}

async function regenerateDocumentEmbeddings(documentId: string): Promise<void> {
  // 1. Get all chunks for document
  const chunks = await prisma.documentChunk.findMany({
    where: { documentId }
  })

  // 2. Clear existing embeddings
  await prisma.documentChunk.updateMany({
    where: { documentId },
    data: { embedding: null }
  })

  // 3. Generate new embeddings in batches
  const BATCH_SIZE = 10
  for (let i = 0; i < chunks.length; i += BATCH_SIZE) {
    const batch = chunks.slice(i, i + BATCH_SIZE)
    await generateEmbeddingsForChunks(batch)
  }

  // 4. Update document status
  await prisma.document.update({
    where: { id: documentId },
    data: { processedAt: new Date() }
  })
}
```

---

## User Experience

### Edit Flow

1. **Document List View**
   - Editable documents show "Edit" button (pencil icon)
   - PDFs show "View" button only with "Read-only" badge
   - Version indicator: "v3 • Last edited Dec 7"

2. **Editor View**
   - Full-page modal or dedicated route
   - Toolbar at top with formatting options
   - Content area with TipTap editor
   - Save button (primary) and Close button (secondary)
   - Optional change note input on save

3. **Version History**
   - Accessible via "History" button or dropdown
   - Timeline of all versions with metadata
   - Compare any two versions with diff view
   - Rollback with confirmation dialog

### Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Cmd/Ctrl + S | Save document |
| Cmd/Ctrl + Z | Undo |
| Cmd/Ctrl + Shift + Z | Redo |
| Cmd/Ctrl + B | Bold |
| Cmd/Ctrl + I | Italic |
| Escape | Close editor (with unsaved changes warning) |

### Visual States

```
┌─────────────────────────────────────────────────────────────────────┐
│  ← Back to Documents        ip-framework.docx          [Save] [×]  │
├─────────────────────────────────────────────────────────────────────┤
│  Version: 3 (Dec 7)  [View History ▼]    ● Unsaved changes         │
├─────────────────────────────────────────────────────────────────────┤
│  [B] [I] [H1] [H2] [H3] [•] [1.] [</>] [❝]                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  # IP Framework                                                     │
│                                                                     │
│  ## Overview                                                        │
│                                                                     │
│  This document outlines our intellectual property protection        │
│  strategy and implementation guidelines.                            │
│                                                                     │
│  [Blinking cursor here]                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Testing Strategy

### Unit Tests

```typescript
// backend/src/services/__tests__/documentVersioning.test.ts

describe('DocumentVersioning', () => {
  describe('createVersion', () => {
    it('should create a new version with incremented version number', async () => {
      // Purpose: Verify version numbers increment correctly
      // This can fail if version increment logic is broken
    })

    it('should preserve original content in version snapshot', async () => {
      // Purpose: Ensure no data loss during versioning
      // This can fail if content serialization has issues
    })

    it('should set editedById to current user', async () => {
      // Purpose: Audit trail - track who made changes
      // This can fail if auth context is not passed correctly
    })
  })

  describe('rollbackToVersion', () => {
    it('should create a new version with old content, not overwrite history', async () => {
      // Purpose: Verify non-destructive rollback behavior
      // This can fail if rollback overwrites instead of creating
    })

    it('should reject rollback to non-existent version', async () => {
      // Purpose: Validate input handling
      // This can fail if validation is missing
    })
  })
})
```

### Integration Tests

```typescript
// backend/src/controllers/__tests__/document.version.test.ts

describe('Document Version API', () => {
  describe('PUT /api/documents/:id/content', () => {
    it('should create version and update chunks', async () => {
      // Purpose: End-to-end save flow verification
    })

    it('should reject non-owner requests', async () => {
      // Purpose: Authorization enforcement
    })

    it('should reject edits to non-editable documents (PDF)', async () => {
      // Purpose: File type restriction enforcement
    })
  })

  describe('Embedding regeneration', () => {
    it('should queue embedding job after successful save', async () => {
      // Purpose: Verify async processing is triggered
    })
  })
})
```

### E2E Tests

```typescript
// e2e/document-editing.spec.ts

describe('Document Editing', () => {
  test('complete edit flow: open, edit, save, verify', async () => {
    // 1. Upload a markdown document
    // 2. Click Edit button
    // 3. Modify content in editor
    // 4. Click Save
    // 5. Verify version incremented
    // 6. Verify content updated in viewer
  })

  test('version history and rollback', async () => {
    // 1. Create document with multiple edits
    // 2. Open version history
    // 3. Compare versions with diff view
    // 4. Rollback to earlier version
    // 5. Verify new version created with old content
  })

  test('unsaved changes warning', async () => {
    // 1. Open editor
    // 2. Make changes
    // 3. Try to close without saving
    // 4. Verify warning dialog appears
  })
})
```

---

## Performance Considerations

### Concern: Large Document Editing

**Mitigation:**
- TipTap handles large documents efficiently with virtual rendering
- Content stored as JSON is more compact than HTML
- Lazy load version history (only fetch content when viewing)

### Concern: Embedding Regeneration Delay

**Mitigation:**
- Embeddings regenerate asynchronously after save
- User sees immediate save confirmation
- RAG queries use existing embeddings until regeneration completes
- Optional: Show "Embeddings updating..." indicator

### Concern: Version History Growth

**Mitigation:**
- Version content is compressed JSON, not duplicated binary files
- Index on (documentId, version) for efficient queries
- Optional future: Archive old versions after N revisions

---

## Security Considerations

### Authorization

- All version endpoints require authentication
- Only project owner can edit, view versions, or rollback
- Viewers (via share link) cannot access version endpoints

### Input Validation

- Sanitize TipTap JSON to prevent XSS
- Validate changeNote length (max 500 chars)
- Rate limit save operations (max 10 saves per minute)

### Audit Trail

- Every version records editedById
- Rollback creates new version, never modifies history
- Source field tracks if edit was manual or from recommendation

---

## Documentation

### Updates Required

1. **API Reference** (specs/03-api-reference.md)
   - Add Document Version endpoints

2. **User Guide** (if exists)
   - Add section on editing documents
   - Add section on version history

3. **Developer Guide**
   - Document TipTap JSON ↔ plaintext conversion
   - Document embedding regeneration queue

---

## Implementation Phases

### Phase 1: Core Editor (MVP)

- [ ] Add DocumentVersion model to schema
- [ ] Add isEditable and currentVersion fields to Document
- [ ] Create initial version (v1) during document processing
- [ ] Implement PUT /api/documents/:id/content endpoint
- [ ] Create DocumentEditor component with TipTap
- [ ] Add Edit button to DocumentUpload for editable types
- [ ] Implement save flow with chunk updates

### Phase 2: Version History

- [ ] Implement GET /api/documents/:id/versions endpoint
- [ ] Create DocumentVersionHistory component
- [ ] Implement POST /api/documents/:id/rollback endpoint
- [ ] Add version indicator to document list

### Phase 3: Diff and Polish

- [ ] Create DocumentDiffViewer component
- [ ] Implement side-by-side comparison
- [ ] Add keyboard shortcuts
- [ ] Add unsaved changes warning
- [ ] Improve loading states and error handling

### Phase 4: Embedding Integration

- [ ] Implement async embedding regeneration
- [ ] Add processing indicator in UI
- [ ] Handle edge cases (regeneration failure)

---

## Open Questions

1. **Autosave**: Should we implement autosave (like Google Docs) or require explicit save?
   - **Current decision:** Explicit save only for MVP
   - **Rationale:** Simpler, clearer versioning semantics

2. **Version Limit**: Should we limit the number of versions per document?
   - **Current decision:** No limit for MVP
   - **Future consideration:** Archive after 50 versions

3. **Concurrent Edit Prevention**: Should we lock documents during editing?
   - **Current decision:** No locking for MVP (single-user context)
   - **Future consideration:** Add optimistic locking if multi-user needed

---

## References

- [TipTap Documentation](https://tiptap.dev/docs)
- [ProseMirror Guide](https://prosemirror.net/docs/guide/)
- [Existing ProfileVersion pattern in codebase](backend/prisma/schema.prisma - ProfileVersion model)
- [Ideation Document](docs/ideation/collaborative-capsule-enhancements.md)
